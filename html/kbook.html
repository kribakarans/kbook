<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KBook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“˜</text></svg>">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.5.1/github-markdown-dark.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
  <!-- Add Material Icons font -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <style>
    :root {
      --bg: #0d1117;
      --panel: #161b22;
      --accent: #58a6ff;
      --text: #c9d1d9;
      --icon-gray: #909090; /* Material gray icon color */
    }
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      color: var(--text);
      background: var(--bg);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .banner {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--panel);
      padding: 10px;
      border-bottom: 1px solid #30363d;
    }
    .banner #file-title {
      font-weight: 600;
      font-size: 18px;
      color: var(--accent);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }
    #search-btn {
      flex-shrink: 0;
      width: 50px;
      height: 40px;
      background: var(--panel);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 24px;
      color: var(--icon-gray);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #search-btn:hover {
      color: var(--accent);
    }
    .content-area {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    .markdown-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    #search-panel {
      display: none;
      width: 320px;
      background: #1e2228;
      border-left: 1px solid #30363d;
      overflow-y: auto;
      padding: 12px;
      box-sizing: border-box;
      position: relative;
    }
    /* Resizer handle for search panel */
    #search-resizer {
      position: absolute;
      left: -3px;
      top: 0;
      bottom: 0;
      width: 6px;
      cursor: col-resize;
      background: transparent;
    }
    #search-resizer:hover {
      background: rgba(88,166,255,0.2);
    }
    /* Search box */
    #search-box {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: none;
      margin-bottom: 10px;
      background: #23262a;
      color: var(--text);
      box-sizing: border-box;

      position: sticky;
      top: 0;
      z-index: 10;
      border-bottom: 1px solid #30363d;
    }
    #search-box:focus {
      outline: none;
      border-color: var(--icon-gray);
      box-shadow: none;
    }
    .search-result {
      padding: 6px;
      border-bottom: 1px solid #30363d;
      cursor: pointer;
    }
    .search-result:hover {
      background: #2a2f36;
    }
    mark {
      background: rgba(88,166,255,0.4);
      padding: 0 2px;
      border-radius: 2px;
    }
    /* Thin scrollbar styling - thinner */
    #search-panel::-webkit-scrollbar,
    .markdown-body::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }
    #search-panel::-webkit-scrollbar-thumb,
    .markdown-body::-webkit-scrollbar-thumb {
      background: #30363d;
      border-radius: 3px;
    }
    #search-panel::-webkit-scrollbar-track,
    .markdown-body::-webkit-scrollbar-track {
      background: transparent;
    }
    @media (max-width: 768px) {
      .content-area {
        flex-direction: column;
        overflow: visible;
      }
      #search-panel {
        width: 100% !important;
        border-left: none;
        border-bottom: 1px solid #30363d;
        max-height: 0; /* initially hidden */
        overflow-y: hidden;
        transition: max-height 0.3s ease;
      }
      .content-area.search-active #search-panel {
        max-height: 40vh; /* visible and scrollable */
        overflow-y: auto;
      }
      .markdown-body {
        padding: 10px 20px 20px 20px;
        max-height: 100vh;
        overflow-y: auto;
        transition: max-height 0.3s ease;
      }
      .content-area.search-active .markdown-body {
        max-height: calc(100vh - 40vh - 50px); /* subtract search panel height + banner height */
      }
    }
  </style>
</head>
<body>
  <div class="banner">
    <div id="file-title">File Title</div>
    <button id="search-btn" onclick="toggleSearchPanel()" aria-label="Toggle Search">
      <span class="material-icons" id="search-icon">search</span>
    </button>
  </div>

  <div class="content-area">
    <article id="content" class="markdown-body"></article>
    <aside id="search-panel">
      <div id="search-resizer"></div>
      <input id="search-box" type="text" placeholder="Search..." oninput="performSearch()" />
      <div id="search-results"></div>
    </aside>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.1/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    const contentEl = document.getElementById('content');
    const fileTitleEl = document.getElementById('file-title');
    const searchPanel = document.getElementById('search-panel');
    const searchBtn = document.getElementById('search-btn');
    const searchBox = document.getElementById('search-box');
    const searchResults = document.getElementById('search-results');
    const searchIcon = document.getElementById('search-icon');

    function getFileFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get('file');
    }

    async function loadFile(file) {
      if (!file) return;
      fileTitleEl.textContent = file;

      // Extract file extension
      const ext = file.split('.').pop().toLowerCase();

      try {
        const res = await fetch(file);
        const data = await res.text();

        if (ext === 'md') {
          contentEl.innerHTML = marked.parse(data);
          hljs.highlightAll();
        } else {
          const langMap = {
            'c': 'c',
            'cpp': 'cpp',
            'py': 'python',
            'js': 'javascript',
            'html': 'html',
            'json': 'json',
            'java': 'java',
            'sh': 'bash'
          };
          const lang = langMap[ext] || '';
          const codeBlock = `<pre><code class="language-${lang}">${escapeHtml(data)}</code></pre>`;
          contentEl.innerHTML = codeBlock;
          hljs.highlightAll();
        }
      } catch (err) {
        contentEl.innerHTML = `<p style="color:red;">Error loading file: ${err}</p>`;
      }
    }

    function escapeHtml(html) {
      return html.replace(/[&<>'"]/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
      }[c]));
    }

    function toggleSearchPanel() {
      const isMobile = window.matchMedia("(max-width: 768px)").matches;

      if (searchPanel.style.display === "none" || !searchPanel.style.display) {
        if (isMobile) {
          // Show search panel above content on mobile
          searchPanel.style.display = "block";
          document.querySelector('.content-area').classList.add('search-active');
        } else {
          // Desktop: show panel side by side
          searchPanel.style.display = "block";
        }
        searchIcon.textContent = "close";
        searchBox.focus();
      } else {
        searchPanel.style.display = "none";
        if (isMobile) {
          document.querySelector('.content-area').classList.remove('search-active');
        }
        searchIcon.textContent = "search";
      }
    }

    function performSearch() {
      const query = searchBox.value.trim().toLowerCase();
      searchResults.innerHTML = "";
      if (!query) return;

      const elements = Array.from(contentEl.querySelectorAll("*"));
      elements.forEach((el, idx) => {
        const text = el.textContent.toLowerCase();
        if (text.includes(query)) {
          const div = document.createElement("div");
          div.className = "search-result";
          div.textContent = `${idx + 1}: ${el.textContent.trim().slice(0, 80)}`;
          div.onclick = () => {
            el.scrollIntoView({ behavior: "smooth", block: "center" });
            el.style.backgroundColor = "rgba(88,166,255,0.2)";
            setTimeout(() => el.style.backgroundColor = "", 2000);
          };
          searchResults.appendChild(div);
        }
      });
    }

    // Resizing logic for search panel
    const searchResizer = document.getElementById('search-resizer');
    let isResizing = false;
    searchResizer.addEventListener('mousedown', () => {
      isResizing = true;
      document.body.style.cursor = 'col-resize';
    });
    window.addEventListener('mousemove', e => {
      if (!isResizing) return;
      const newWidth = window.innerWidth - e.clientX;
      if (newWidth >= 200 && newWidth <= 600) {
        searchPanel.style.width = newWidth + 'px';
      }
    });
    window.addEventListener('mouseup', () => {
      isResizing = false;
      document.body.style.cursor = 'default';
    });

    loadFile(getFileFromQuery());
  </script>
</body>
</html>
